<% content_for :extra_css do %>
  <%= stylesheet_link_tag "dashboard", media: "all" %>
<% end %>

<main class="container mt-4">
  <h1 class="text-light">Your Dashboard</h1>
  <div class="d-flex flex-col align-items-center justify-content-between" style="min-width: 1300px; width: 100%;">
    <div class="spotify-card p-3 mb-4 top-tracks-container" style="min-height: 290px; height: 40vh;">
      <h5 class="text-light mb-1">Your Top Tracks This Year</h5>
      <div class="d-flex flex-row align-items-center justify-content-evenly">
        <% if @primary_track.present? %>
          <div class="d-flex align-items-center mb-3 mt-3 p-3 top-track">
            <% if @primary_track.album_image_url.present? %>
              <%= image_tag @primary_track.album_image_url, 
                            alt: @primary_track.album_name, 
                            class: 'rounded border border-dark me-3', 
                            size: "96x96" %>
            <% end %>
            <div>
              <strong class="text-light fs-5"><%= @primary_track.name %></strong>
              <div class="text-secondary small"><%= @primary_track.artists %></div>
              <div class="text-secondary small">Album: <%= @primary_track.album_name %></div>
              <div class="text-secondary small">Popularity: <%= @primary_track.popularity %>/100</div>
            </div>
            <p class="first-track-badge badge me-2 text-dark">#1</p>
          </div>
        <% else %>
          <p class="text-secondary mb-3">
            We couldn't load your top tracks right now. Please try again soon.
          </p>
        <% end %>

        <% if @top_tracks.drop(1).any? %>
          <ul class="list-unstyled text-secondary small mb-0">
            <% @top_tracks.drop(1).first(4).each_with_index do |track, idx| %>
              <% next if track.blank? %>
              <li class="d-flex align-items-start">
                <span class="badge bg-secondary me-2">#<%= idx + 2 %></span>
                <div>
                  <span class="text-light"><%= track.name %></span>
                  <div class="text-secondary small"><%= track.artists %></div>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>

      <div class="mt-3 text-center">
        <%= link_to 'View Top Tracks', top_tracks_path , class: 'btn btn-spotify' %>
      </div>
    </div>

    <div class="spotify-card p-3 mb-4 top-genre-container" style="min-height: 290px; height: 40vh;">
      <h5 class="text-light mb-2">Your Top Genres This Year</h5>
      <div>
        <% if @genre_chart.present? %>
          <div class="d-flex flex-row align-items-center justify-content-evenly">
            <div>
              <canvas id="genrePie" width="220" height="220"
                      aria-label="Top genres chart" role="img"></canvas>

              <!-- No-JS static pie fallback -->
              <% colors = spotify_colors %>
              <noscript>
                <% total = @genre_chart[:datasets][0][:data].sum.to_f %>
                <% start_angle = 0.0 %>
                <% gradient_segments = @genre_chart[:datasets][0][:data].map.with_index do |val, i|
                    pct = total.zero? ? 0.0 : val.to_f / total
                    end_angle = start_angle + (pct * 360.0)
                    color = colors[i % colors.length]
                    seg = "#{color} #{start_angle.round(1)}deg #{end_angle.round(1)}deg"
                    start_angle = end_angle
                    seg
                  end.join(', ') %>

                <div class="static-pie" style="
                    width: 260px; height: 260px;
                    border-radius: 50%;
                    background: conic-gradient(<%= gradient_segments.html_safe %>);
                    border: 1px solid rgba(255,255,255,0.1);
                  ">
                </div>
              </noscript>
            </div>

            <div class="genre-list">
              <ul class="list-unstyled mt-1 small">
                <% @genre_chart[:labels].each_with_index do |label, i| %>
                  <li class="text-secondary mb-1">
                    <span class="text-light fw-semibold"><%= label %></span>
                    â€” <%= @genre_chart[:datasets][0][:data][i] %>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
        <% else %>
          <p class="text-secondary text-center mb-0">No genre data available.</p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="d-flex flex-col align-items-center justify-content-between" style="min-width: 1300px; width: 100%;">
    <div class="spotify-card p-3 mb-4 top-artists-container">
      <h5 class="text-light mb-1">Your Top Artists This Year</h5>
      <div class="d-flex flex-row align-items-center justify-content-evenly">
        <% if @primary_artist.present? %>
          <div class="d-flex align-items-center mb-3 mt-3 p-3 top-track">
            <% if @primary_artist.image_url.present? %>
              <%= image_tag @primary_artist.image_url, 
                            alt: @primary_artist.name, 
                            class: 'rounded-circle border me-3', 
                            size: "96x96" %>
            <% end %>
            <div>
              <strong class="text-light fs-5"><%= @primary_artist.name %></strong>
              <div class="text-secondary small">Plays: <%= @primary_artist.playcount %></div>
            </div>
            <p class="first-track-badge badge me-2 text-dark">#1</p>
          </div>
        <% else %>
          <p class="text-secondary mb-3">
            We couldn't load your top artists right now. Please try again soon.
          </p>
        <% end %>

        <% if @top_artists.drop(1).any? %>
          <ul class="list-unstyled text-secondary small mb-0">
            <% @top_artists.drop(1).first(4).each_with_index do |artist, idx| %>
              <% next if artist.blank? %>
              <li class="d-flex align-items-start">
                <span class="badge bg-secondary me-2">#<%= idx + 2 %></span>
                <div>
                  <span class="text-light"><%= artist.name %></span>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>
      <div class="mt-3 text-center">
        <%= link_to 'View Top Artists', top_artists_path, class: 'btn btn-spotify' %>
      </div>
    </div>

    <div class="spotify-card p-3 mb-4 followed-artists-container ms-2 me-2">
      <h5 class="text-light mb-2">Followed Artists (20)</h5>
      <div class="followed-artists-wrapper">
        <% if @followed_artists.present? %>
          <% @followed_artists.each do |artist| %>
            <% next if artist.blank? %>
            <div class="followed-artists-card">
              <% if artist.image_url.present? %>
                <%= image_tag artist.image_url, 
                              alt: artist.name, 
                              class: 'rounded-circle border me-3 ms-3', 
                              size: "40x40" %>
              <% end %>
              <div class="d-flex flex-column justify-content-start">
                <p class="text-light fw-bold me-3" style="margin-bottom: 0 !important; "><%= artist.name %></p>
                <%= link_to artist.spotify_url , class: 'd-flex flex-row align-items-center text-primary', style: "margin-bottom: 0 !important; font-size: 12px;", target: "_blank", rel: "noopener noreferrer" do %>
                  <p class="text-primary me-1" style="margin-bottom: 0 !important; font-size: 12px;">View in Spotify</p>
                  <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16"><path d="M0 0h24v24H0z" fill="none"/><path fill="rgb(13,110,253)" d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>  
          <p class="followed-artists-card text-center">
            We couldn't load your followed artists right now. Please try again soon.
          </p>
        <% end %>
      </div>
    </div>

    <div class="spotify-card p-3 mb-4 new-releases-container">
      <h5 class="text-light mb-1">Featured Releases</h5>
      <div class="d-flex flex-column justify-content-evenly" style="height: 250px;">
        <% if @new_releases.present? %>
          <% @new_releases.each do |release| %>
            <% next if release.blank? %>
            <div class="d-flex flex-row align-items-center justify-content-start">
              <% if release.image_url.present? %>
                <%= image_tag release.image_url, 
                              alt: release.name, 
                              class: 'rounded border border-dark me-3', 
                              size: "100x100" %>
              <% end %>
              <div class="text-sm">
                <p class="text-light" style="margin-bottom: 0 !important; font-weight: 700;"> <%= release.name %> </p>
                <p style="margin-bottom: 0 !important;"> Artist(s): <%= release.artists.join(', ') %> </p>
                <p style="margin-bottom: 0 !important;"> Total Tracks: <%= release.total_tracks %> </p>
                <p style="margin-bottom: 0 !important;"> Release Date: <%= release.release_date %> </p>
                <%= link_to release.spotify_url , class: 'd-flex flex-row align-items-center text-primary', style: "margin-bottom: 0 !important; font-size: 14px;", target: "_blank", rel: "noopener noreferrer" do %>
                  <p class="text-primary me-1" style="margin-bottom: 0 !important; font-size: 12px;">View in Spotify</p>
                  <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16"><path d="M0 0h24v24H0z" fill="none"/><path fill="rgb(13,110,253)" d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="text-secondary mb-3 text-center">
            We couldn't load new releases right now. Please try again soon.
          </p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="d-flex flex-col align-items-center justify-content-between" style="min-width: 1300px; width: 100%;">
    <div class="spotify-card p-3 mb-4" style="width: 49%;">
      <h5 class="text-light mb-3">Saved Shows</h5>
      <% if @saved_shows_dashboard.present? %>
        <div class="d-flex gap-2 mb-3 overflow-hidden flex-wrap">
          <% @saved_shows_dashboard.each do |show| %>
            <% if show.image_url %>
              <img src="<%= show.image_url %>" alt="<%= show.name %>" class="rounded shadow-sm" style="width: 64px; height: 64px; object-fit: cover;">
            <% end %>
          <% end %>
        </div>
      <% else %>
        <p class="text-secondary">View and manage your saved podcasts and shows.</p>
      <% end %>
      <div class="text-center mt-auto">
        <%= link_to 'View Saved Shows', saved_shows_path, class: 'btn btn-spotify' %>
      </div>
    </div>

    <div class="spotify-card p-3 mb-4" style="width: 49%;">
      <h5 class="text-light mb-3">Saved Episodes</h5>
      <% if @saved_episodes_dashboard.present? %>
        <div class="d-flex gap-2 mb-3 overflow-hidden flex-wrap">
          <% @saved_episodes_dashboard.each do |episode| %>
            <% if episode.image_url %>
              <img src="<%= episode.image_url %>" alt="<%= episode.name %>" class="rounded shadow-sm" style="width: 64px; height: 64px; object-fit: cover;">
            <% end %>
          <% end %>
        </div>
      <% else %>
        <p class="text-secondary">View and manage your saved podcast episodes.</p>
      <% end %>
      <div class="text-center mt-auto">
        <%= link_to 'View Saved Episodes', saved_episodes_path, class: 'btn btn-spotify' %>
      </div>
    </div>
  </div>

<%# Load Chart.js and render ONLY if data present %>
<% if @genre_chart.present? %>
  <!-- The exact same palette used by <noscript> -->
  <script type="application/json" id="genreData"><%= raw(@genre_chart.to_json) %></script>
  <script type="application/json" id="genreColors"><%= raw(spotify_colors.to_json) %></script>

  <!-- Load Chart.js, then render -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"
          onload="renderGenreChart()"
          defer></script>

  <script>
    function renderGenreChart() {
      if (!document.getElementById('genrePie')) {
        return document.addEventListener('DOMContentLoaded', renderGenreChart, { once: true });
      }
      if (!window.Chart) { return setTimeout(renderGenreChart, 0); }

      var canvas = document.getElementById('genrePie');
      var ctx    = canvas.getContext('2d');

      var data   = JSON.parse(document.getElementById('genreData').textContent);
      var colors = JSON.parse(document.getElementById('genreColors').textContent);

      data.datasets[0].backgroundColor = data.labels.map(function(_, i){ return colors[i % colors.length]; });
      data.datasets[0].borderColor = '#101010';
      data.datasets[0].borderWidth = 1;

      new Chart(ctx, {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#181818',
              titleColor: '#FFFFFF',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: { label: function(c){ return c.label + ': ' + c.parsed; } }
            }
          }
        }
      });
    }
  </script>
<% end %>
</main>
